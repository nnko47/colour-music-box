<!DOCTYPE html>
<html>
<head>
    <title>颜色八音盒 - 改进版</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #camera { width: 100vw; height: 100vh; object-fit: cover; }
        .target-point {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.7);
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        #target1 { top: 30%; left: 30%; border-color: #ff0000; }
        #target2 { top: 50%; left: 50%; border-color: #00ff00; }
        #target3 { top: 70%; left: 70%; border-color: #0000ff; }
        #colorInfo {
            position: absolute;
            top: 20px; left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        #controls {
            position: absolute;
            bottom: 20px; left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <video id="camera" autoplay playsinline></video>
    <div class="target-point" id="target1"></div>
    <div class="target-point" id="target2"></div>
    <div class="target-point" id="target3"></div>
    <div id="colorInfo">请点击屏幕启动摄像头</div>
    <div id="controls">
        <button onclick="toggleSmooth()">平滑模式: 开启</button>
        <button onclick="toggleCamera()">切换摄像头</button>
    </div>

    <script>
        // 音频上下文和状态变量
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let currentOscillators = [null, null, null];
        let lastHues = [0, 0, 0];
        let lastPlayTimes = [0, 0, 0];
        let isSmoothMode = true;
        let cameraStarted = false;
        let currentFacingMode = 'environment';
        
        // 获取DOM元素
        const video = document.getElementById('camera');
        const colorInfo = document.getElementById('colorInfo');
        
        // 点击启动摄像头
        function startCameraOnClick() {
            if (cameraStarted) return;
            
            cameraStarted = true;
            colorInfo.textContent = '正在启动摄像头...';
            
            // 启动摄像头
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: { ideal: currentFacingMode },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
            .then(stream => {
                video.srcObject = stream;
                colorInfo.textContent = '后置摄像头已开启 - 开始检测颜色';
                startColorDetection();
            })
            .catch(err => {
                console.log('后置摄像头失败:', err);
                colorInfo.textContent = '后置摄像头失败，尝试普通摄像头';
                // 降级到普通摄像头
                navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    colorInfo.textContent = '摄像头已开启 - 开始检测颜色';
                    startColorDetection();
                })
                .catch(finalErr => {
                    colorInfo.textContent = '摄像头启动失败: ' + finalErr.message;
                });
            });
        }

        // 开始颜色检测
        function startColorDetection() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const targetPoints = [
                { x: 0.3, y: 0.3 }, // 对应target1
                { x: 0.5, y: 0.5 }, // 对应target2
                { x: 0.7, y: 0.7 }  // 对应target3
            ];
            
            function detectColor() {
                if (!video.srcObject || video.videoWidth === 0) {
                    requestAnimationFrame(detectColor);
                    return;
                }
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                let infoText = '颜色检测中...<br>';
                
                // 检测三个点的颜色
                targetPoints.forEach((point, index) => {
                    const x = Math.floor(point.x * canvas.width);
                    const y = Math.floor(point.y * canvas.height);
                    const pixel = ctx.getImageData(x, y, 1, 1).data;
                    const [r, g, b] = pixel;
                    const hsl = rgbToHsl(r, g, b);
                    const [h, s, l] = hsl;
                    
                    infoText += `点${index+1}: RGB(${r},${g},${b}) HSL(${Math.round(h*360)}°,${Math.round(s*100)}%,${Math.round(l*100)}%)<br>`;
                    
                    // 播放对应声音
                    playSoundFromColor(h, s, l, index);
                });
                
                colorInfo.innerHTML = infoText;
                requestAnimationFrame(detectColor);
            }
            
            detectColor();
        }
        
        // 改进的颜色转声音函数
        function playSoundFromColor(hue, saturation, lightness, pointIndex) {
            const now = Date.now();
            const timeSinceLastPlay = now - lastPlayTimes[pointIndex];
            
            // 平滑模式：防抖处理
            if (isSmoothMode) {
                const hueDifference = Math.abs(hue - lastHues[pointIndex]);
                if (hueDifference < 0.03 && timeSinceLastPlay < 300) {
                    return;
                }
            }
            
            lastHues[pointIndex] = hue;
            lastPlayTimes[pointIndex] = now;
            
            // 停止该点的上一个声音
            if (currentOscillators[pointIndex]) {
                currentOscillators[pointIndex].stop();
            }
            
            // 白色静音
            if (lightness > 0.85) {
                return;
            }
            
            // 黑色鼓点
            if (lightness < 0.15) {
                playDrum(pointIndex);
                return;
            }
            
            // 五声音阶（更和谐）
            const pentatonicScale = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25];
            const noteIndex = Math.floor(hue * pentatonicScale.length);
            const baseFrequency = pentatonicScale[noteIndex];
            
            // 饱和度控制八度（更明显的音高变化）
            const octave = Math.floor(saturation * 2) + 1;
            const frequency = baseFrequency * octave;
            
            // 亮度控制音量（指数曲线让变化更明显）
            const volume = Math.pow(lightness, 1.5) * 0.6;
            
            // 不同点使用不同音色
            const waveTypes = ['sine', 'triangle', 'sawtooth'];
            const waveType = waveTypes[pointIndex % waveTypes.length];
            
            // 创建声音
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = waveType;
            oscillator.frequency.value = frequency;
            
            // 平滑的淡入淡出
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.1);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            currentOscillators[pointIndex] = oscillator;
            
            // 0.5秒后自动停止，避免声音堆积
            setTimeout(() => {
                if (currentOscillators[pointIndex] === oscillator) {
                    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1);
                    setTimeout(() => {
                        oscillator.stop();
                    }, 100);
                }
            }, 500);
        }
        
        function playDrum(pointIndex) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.2);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.2);
        }
        
        // RGB转HSL
        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [h, s, l];
        }
        
        // 控制函数
        function toggleSmooth() {
            isSmoothMode = !isSmoothMode;
            document.querySelector('button').textContent = 
                `平滑模式: ${isSmoothMode ? '开启' : '关闭'}`;
        }
        
        function toggleCamera() {
            if (!cameraStarted) return;
            
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            // 停止当前视频流
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            // 重启摄像头
            startCameraOnClick();
        }
        
        // 点击事件监听
        document.addEventListener('click', function() {
            startCameraOnClick();
            // 同时恢复音频上下文
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        });
        
        document.addEventListener('touchstart', function() {
            startCameraOnClick();
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        });
    </script>
</body>
</html>
