<!DOCTYPE html>
<html>
<head>
    <title>颜色八音盒</title>
    <style>
        body { margin: 0; overflow: hidden; }
        #camera { width: 100vw; height: 100vh; }
        #target {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 50px;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #colorInfo {
            position: absolute;
            top: 20px; left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <video id="camera" autoplay playsinline></video>
    <div id="target"></div>
    <div id="colorInfo">正在启动摄像头...</div>

    <script>
        // 获取摄像头权限
        const video = document.getElementById('camera');
        const colorInfo = document.getElementById('colorInfo');
        
        // 音频上下文
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let currentOscillator = null;
        
        // 启动摄像头
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                colorInfo.textContent = '摄像头已开启 - 开始检测颜色';
                startColorDetection();
            })
            .catch(err => {
                colorInfo.textContent = '无法访问摄像头: ' + err.message;
            });
        
        function startColorDetection() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            function detectColor() {
                // 设置canvas尺寸与视频一致
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // 绘制当前视频帧
                ctx.drawImage(video, 0, 0);
                
                // 获取中心点颜色（目标区域）
                const x = canvas.width / 2;
                const y = canvas.height / 2;
                const pixel = ctx.getImageData(x, y, 1, 1).data;
                
                const [r, g, b] = pixel;
                
                // 转换为HSL色彩空间
                const hsl = rgbToHsl(r, g, b);
                const [h, s, l] = hsl;
                
                
// 更新显示信息
                colorInfo.innerHTML = 
                    `RGB: ${r},${g},${b}<br>
                     HSL: ${Math.round(h*360)}°, ${Math.round(s*100)}%, ${Math.round(l*100)}%`;
                
                // 根据颜色播放声音
                playSoundFromColor(h, s, l);
                
                // 持续检测
                requestAnimationFrame(detectColor);
            }
            
            detectColor();
        }
        
        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0; // 灰色
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [h, s, l];
        }
        
        function playSoundFromColor(hue, saturation, lightness) {
            // 停止当前声音
            if (currentOscillator) {
                currentOscillator.stop();
            }
            
            // 白色或接近白色时静音
            if (lightness > 0.9) {
                return;
            }
            
            // 黑色或接近黑色时播放鼓点
            if (lightness < 0.1) {
                playDrum();
                return;
            }
            
            // 创建新振荡器
            currentOscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            // 色相映射到音高 (Do Re Mi)
            const notes = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25]; // C4 to C5
            const noteIndex = Math.floor(hue * notes.length);
            const frequency = notes[noteIndex];
            
            // 饱和度映射到音高微调
            const detune = (saturation - 0.5) * 100; // -50 到 +50 音分
            
            // 亮度映射到音量
            const volume = lightness * 0.5; // 限制最大音量
            
            currentOscillator.type = 'sine';
            currentOscillator.frequency.value = frequency;
            currentOscillator.detune.value = detune;
            gainNode.gain.value = volume;
            
            currentOscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            currentOscillator.start();
        }
        
        function playDrum() {
            // 简单的鼓声效果
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = 'sine';
            oscillator.frequency.value = 100;
            oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.1);
            
            gainNode.gain.value = 0.3;
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);
        }
    </script>
</body>
</html>
