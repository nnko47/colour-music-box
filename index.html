<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¨ å£°éŸ³ç”µå­ç»˜ç”»</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 20px; background-color: #f4f4f4; }
        #controls { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; background-color: #fff; border-radius: 8px; width: 800px; max-width: 90%; }
        #canvas { border: 2px solid #333; cursor: crosshair; background-color: #fff; }
        .slider-group { display: flex; align-items: center; margin-bottom: 10px; }
        .slider-group label { width: 80px; font-weight: bold; }
        .slider-group input[type="range"] { flex-grow: 1; margin-right: 15px; }
        .value-display { width: 30px; text-align: right; }
        #currentColor { width: 50px; height: 25px; border: 1px solid #000; margin-left: 20px; }
        #brushSizeDisplay { margin-left: 10px; }
        /* å½•åˆ¶åŠŸèƒ½æ ·å¼ */
        #recordingControls { margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; text-align: center; }
        #recordingControls button { padding: 8px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; transition: background-color 0.2s; }
        #recordBtn { background-color: #e74c3c; color: white; }
        #stopBtn { background-color: #f39c12; color: white; }
        #playBtn { background-color: #2ecc71; color: white; }
        .disabled { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

    <h1>å£°éŸ³ç”µå­ç»˜ç”» ğŸ¶</h1>

    <div id="controls">
        <div class="slider-group">
            <label for="hSlider">è‰²ç›¸ (H)</label>
            <input type="range" id="hSlider" min="0" max="360" value="0" oninput="updateColorAndPreview()">
            <span class="value-display" id="hValue">0</span>Â°
        </div>
        <div class="slider-group">
            <label for="sSlider">é¥±å’Œåº¦ (S)</label>
            <input type="range" id="sSlider" min="0" max="100" value="100" oninput="updateColorAndPreview()">
            <span class="value-display" id="sValue">100</span>%
        </div>
        <div class="slider-group">
            <label for="lSlider">æ˜åº¦ (L)</label>
            <input type="range" id="lSlider" min="0" max="100" value="50" oninput="updateColorAndPreview()">
            <span class="value-display" id="lValue">50</span>%
        </div>

        <div class="slider-group">
            <label for="sizeSlider">ç¬”åˆ·å¤§å°</label>
            <input type="range" id="sizeSlider" min="1" max="50" value="5" oninput="updateBrushSize()">
            <span class="value-display" id="sizeValue">5</span>px
            <span style="margin-left: 20px;">å½“å‰é¢œè‰²:</span>
            <div id="currentColor"></div>
        </div>

        <div id="recordingControls">
            <p><strong>ç¬”ç”»å½•åˆ¶ä¸ç¼–æ›²ï¼š</strong></p>
            <button id="recordBtn">ğŸ”´ å½•åˆ¶</button>
            <button id="stopBtn" class="disabled">â¹ åœæ­¢</button>
            <button id="playBtn" class="disabled">â–¶ï¸ æ’­æ”¾/é¢„è§ˆ</button>
            <button id="clearBtn">ğŸ—‘ æ¸…ç©ºç”»å¸ƒå’Œå½•éŸ³</button>
        </div>
    </div>

    <canvas id="canvas" width="800" height="400"></canvas>

    <script>
        // ------------------------------------
        // I. å…¨å±€é…ç½®ä¸åˆå§‹åŒ–
        // ------------------------------------
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const hSlider = document.getElementById('hSlider');
        const sSlider = document.getElementById('sSlider');
        const lSlider = document.getElementById('lSlider');
        const sizeSlider = document.getElementById('sizeSlider');
        const currentColorDisplay = document.getElementById('currentColor');
        const hValueDisplay = document.getElementById('hValue');
        const sValueDisplay = document.getElementById('sValue');
        const lValueDisplay = document.getElementById('lValue');
        
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // Web Audio API å®ä¾‹
        let audioContext;
        let currentOscillator = null;
        let currentGain = null;
        let drumBuffer = null; // é¼“ç‚¹éŸ³é¢‘ç¼“å†²
        
        // å½•åˆ¶ç›¸å…³å˜é‡
        let isRecording = false;
        let recordingStartTime = 0;
        let recordedStrokes = [];
        let currentStroke = null;

        // é¢œè‰²æ˜ å°„åˆ° MIDI éŸ³é«˜ï¼ˆC4 = 60ï¼‰
        // 0(çº¢) -> C(0), 60(é»„) -> D(2), 120(ç»¿) -> E(4), 180(é’) -> F(5), 240(è“) -> G(7), 300(ç´«) -> A(9), 330(æ´‹çº¢/çº¢) -> B(11)
        const BASE_MIDI = 48; // C3 (æœ€ä½å…«åº¦)

        /** åˆå§‹åŒ–éŸ³é¢‘ç¯å¢ƒå’ŒåŠ è½½é¼“ç‚¹é‡‡æ · */
        async function initializeAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // æ¨¡æ‹ŸåŠ è½½ä¸€ä¸ªé¼“ç‚¹é‡‡æ ·ï¼ˆå®é™…é¡¹ç›®ä¸­æ‚¨éœ€è¦åŠ è½½ä¸€ä¸ªçœŸå®çš„éŸ³é¢‘æ–‡ä»¶ï¼‰
                // è¿™é‡Œæˆ‘ä»¬ä»…åˆ›å»ºä¸€ä¸ªç®€å•ä¸”çŸ­ä¿ƒçš„ç™½å™ªéŸ³ä½œä¸ºç¤ºä¾‹é¼“ç‚¹
                drumBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.1, audioContext.sampleRate);
                const data = drumBuffer.getChannelData(0);
                for (let i = 0; i < data.length; i++) {
                    data[i] = Math.random() * 2 - 1; // éšæœºå€¼æ¨¡æ‹Ÿå™ªéŸ³
                }
            }
        }
        
        /** å°† HSL å‚æ•°è½¬æ¢ä¸º CSS é¢œè‰²å­—ç¬¦ä¸² */
        function getCssColor(h, s, l) {
            return `hsl(${h}, ${s}%, ${l}%)`;
        }

        /** å°† HLS è½¬æ¢ä¸º MIDI éŸ³é«˜å’ŒéŸ³é‡ */
        function getSoundParams(h, s, l) {
            // 1. è‰²ç›¸ (H) -> åŠéŸ³ (0-11)
            // ç®€å•çº¿æ€§æ˜ å°„ï¼š360åº¦/12ä¸ªåŠéŸ³ = 30åº¦/åŠéŸ³
            // ç”±äºç”¨æˆ·è¦æ±‚ä¸ƒä¸ªä¸»éŸ³å¯¹åº”ä¸ƒç§ä¸»è‰²ï¼Œæˆ‘ä»¬ä½¿ç”¨æ›´å¤æ‚çš„éçº¿æ€§æ˜ å°„ï¼Œä½†ä¸ºç®€åŒ–ç¤ºä¾‹ï¼Œä»é‡‡ç”¨çº¿æ€§ï¼š
            let semitone = Math.round(h / 30); // 0-12ï¼Œ12å’Œ0ä¸€æ ·
            if (semitone === 12) semitone = 0;
            
            // 2. é¥±å’Œåº¦ (S) -> å…«åº¦ (MIDI Offset)
            // 100% S æ˜ å°„åˆ° 3ä¸ªå…«åº¦ (36 semitones)
            // æ˜ å°„ S (0-100) åˆ° 0-36 çš„åŠéŸ³åç§»
            const octaveOffset = Math.round((s / 100) * 36); 
            
            // 3. æ˜åº¦ (L) -> å¢ç›Š (éŸ³é‡ 0-1)
            const gain = l / 100;
            
            // 4. è®¡ç®—æœ€ç»ˆ MIDI Note Number
            const midiNote = BASE_MIDI + semitone + octaveOffset;
            
            // 5. è½¬æ¢ MIDI åˆ°é¢‘ç‡ (Hz)
            const frequency = 440 * Math.pow(2, (midiNote - 69) / 12);
            
            return { frequency, gain };
        }

        /** æ’­æ”¾é¼“ç‚¹ */
        function playDrum(delay = 0) {
            if (!drumBuffer) return;
            const source = audioContext.createBufferSource();
            source.buffer = drumBuffer;
            source.connect(audioContext.destination);
            source.start(audioContext.currentTime + delay);
        }

        // ------------------------------------
        // II. å£°éŸ³æ§åˆ¶
        // ------------------------------------
        
        /** å¼€å§‹æŒç»­éŸ³ */
        function startSound(h, s, l) {
            if (l === 0) {
                // é»‘è‰² (L=0) ä»…æ’­æ”¾é¼“ç‚¹ä¸€æ¬¡
                playDrum();
                return;
            }

            if (currentOscillator) stopSound();
            
            const { frequency, gain } = getSoundParams(h, s, l);

            currentOscillator = audioContext.createOscillator();
            currentGain = audioContext.createGain();

            // è®¾ç½®éŸ³è‰²å’Œé¢‘ç‡
            currentOscillator.type = 'sine'; // å¯ä»¥å°è¯• 'sawtooth' æˆ– 'square'
            currentOscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

            // è®¾ç½®éŸ³é‡
            currentGain.gain.setValueAtTime(gain, audioContext.currentTime);

            // è¿æ¥èŠ‚ç‚¹ï¼šæŒ¯è¡å™¨ -> å¢ç›Š -> æ‰¬å£°å™¨
            currentOscillator.connect(currentGain);
            currentGain.connect(audioContext.destination);

            currentOscillator.start();
        }

        /** åœæ­¢æŒç»­éŸ³ */
        function stopSound() {
            if (currentOscillator) {
                // ä½¿ç”¨ AudioParam.linearRampToValueAtTime åˆ›å»ºä¸€ä¸ªæ·¡å‡ºæ•ˆæœ
                currentGain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1); // 100ms æ·¡å‡º
                
                // åœ¨æ·¡å‡ºå®Œæˆååœæ­¢æŒ¯è¡å™¨
                currentOscillator.stop(audioContext.currentTime + 0.1); 
            }
            currentOscillator = null;
            currentGain = null;
        }

        // ------------------------------------
        // III. ç»˜ç”»ä¸äº¤äº’
        // ------------------------------------
        
        /** æ›´æ–°é¢œè‰²æ˜¾ç¤ºå’Œé¢„è§ˆéŸ³æ•ˆ */
        function updateColorAndPreview() {
            const h = parseInt(hSlider.value);
            const s = parseInt(sSlider.value);
            const l = parseInt(lSlider.value);
            
            hValueDisplay.textContent = h;
            sValueDisplay.textContent = s;
            lValueDisplay.textContent = l;
            
            const cssColor = getCssColor(h, s, l);
            currentColorDisplay.style.backgroundColor = cssColor;

            // é¢„è§ˆéŸ³æ•ˆï¼šåœ¨æ‹–åŠ¨æ»‘å—æ—¶æ’­æ”¾çŸ­æš‚éŸ³
            if (!isDrawing && audioContext) {
                if (l === 0) {
                    playDrum();
                } else {
                    const { frequency, gain } = getSoundParams(h, s, l);
                    
                    const osc = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    osc.type = 'triangle'; 
                    osc.frequency.setValueAtTime(frequency, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(gain * 0.5, audioContext.currentTime); // é¢„è§ˆéŸ³ç¨è½»

                    osc.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    osc.start();
                    osc.stop(audioContext.currentTime + 0.15); // 150ms é¢„è§ˆéŸ³
                }
            }
        }

        /** æ›´æ–°ç¬”åˆ·å¤§å°æ˜¾ç¤º */
        function updateBrushSize() {
            document.getElementById('sizeValue').textContent = sizeSlider.value;
        }

        /** ç»˜åˆ¶ç¬”ç”» */
        function draw(e) {
            if (!isDrawing) return;
            const h = parseInt(hSlider.value);
            const s = parseInt(sSlider.value);
            const l = parseInt(lSlider.value);

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.strokeStyle = getCssColor(h, s, l);
            ctx.lineWidth = sizeSlider.value;
            ctx.lineCap = 'round';
            ctx.stroke();

            [lastX, lastY] = [e.offsetX, e.offsetY];

            // å¦‚æœæ˜¯æŒç»­éŸ³ï¼Œå¯ä»¥æ ¹æ®ç§»åŠ¨é€Ÿåº¦/ä½ç½®æ›´æ–°éŸ³é‡/é¢‘ç‡ï¼Œä½†ä¸ºç®€åŒ–æ­¤å¤„çœç•¥ã€‚
        }

        /** å¼€å§‹ç»˜ç”»äº‹ä»¶ */
        function startDrawing(e) {
            // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å·²æ¿€æ´»ï¼ˆç”¨æˆ·äº¤äº’åæ‰èƒ½æ¿€æ´»ï¼‰
            initializeAudio();

            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];

            const h = parseInt(hSlider.value);
            const s = parseInt(sSlider.value);
            const l = parseInt(lSlider.value);
            const size = parseInt(sizeSlider.value);

            // å¯åŠ¨æŒç»­éŸ³ (L > 0) æˆ–é¼“ç‚¹ (L = 0)
            startSound(h, s, l);
            
            // å½•åˆ¶é€»è¾‘
            if (isRecording) {
                // è®°å½•å‰ä¸€ä¸ªç¬”ç”»ç»“æŸåˆ°å½“å‰ç¬”ç”»å¼€å§‹çš„ç©ºç™½æ—¶é—´
                const now = Date.now();
                if (currentStroke && currentStroke.type === 'stroke') {
                    // è®°å½•ä¸Šä¸€ç¬”ç”»çš„ç»“æŸæ—¶é—´
                    currentStroke.duration = now - currentStroke.startTime;
                    recordedStrokes.push(currentStroke);
                }
                
                // è®°å½•æ–°çš„ç¬”ç”»
                currentStroke = {
                    startTime: now,
                    h: h,
                    s: s,
                    l: l,
                    size: size,
                    points: [{ x: lastX, y: lastY }],
                    type: (l === 0) ? 'drum' : 'stroke', // é»‘è‰²é¼“ç‚¹åªè®°å½•ä¸€æ¬¡ç‚¹å‡»
                };
            }

            draw(e); // ç»˜åˆ¶ç¬¬ä¸€ä¸ªç‚¹
        }

        /** ç»“æŸç»˜ç”»äº‹ä»¶ */
        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            stopSound();

            // å½•åˆ¶é€»è¾‘ï¼šç»“æŸå½“å‰ç¬”ç”»å¹¶åŠ å…¥è®°å½•
            if (isRecording && currentStroke) {
                const now = Date.now();
                if (currentStroke.type === 'stroke') {
                    currentStroke.duration = now - currentStroke.startTime;
                    recordedStrokes.push(currentStroke);
                } else if (currentStroke.type === 'drum') {
                    // é¼“ç‚¹åªéœ€è¦ä¸€ä¸ªç‚¹ï¼Œduration å¾ˆçŸ­
                    currentStroke.duration = 50; 
                    recordedStrokes.push(currentStroke);
                }
                currentStroke = null;
            }
        }
        
        // ç›‘å¬ç»˜ç”»äº‹ä»¶
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing); // é¼ æ ‡ç§»å‡ºç”»å¸ƒä¹Ÿåœæ­¢
        
        // åˆå§‹åŒ–é¢œè‰²å’Œç¬”åˆ·å¤§å°æ˜¾ç¤º
        updateColorAndPreview();
        updateBrushSize();
        
        // ------------------------------------
        // IV. å½•åˆ¶ä¸ç¼–æ›²åŠŸèƒ½ (ç®€åŒ–ç‰ˆ)
        // ------------------------------------
        
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const playBtn = document.getElementById('playBtn');
        const clearBtn = document.getElementById('clearBtn');
        
        function handleRecord() {
            isRecording = true;
            recordingStartTime = Date.now();
            currentStroke = null; // æ¸…ç©ºå½“å‰æœªå®Œæˆçš„ç¬”ç”»
            
            // æ¯æ¬¡å½•åˆ¶éƒ½å åŠ ï¼Œæ‰€ä»¥ä¸æ¸…ç©º previous recordedStrokes
            recordBtn.classList.add('disabled');
            stopBtn.classList.remove('disabled');
            playBtn.classList.add('disabled');
            console.log("ğŸ”´ å¼€å§‹å½•åˆ¶...");
        }

        function handleStop() {
            if (!isRecording) return;
            isRecording = false;
            
            // ç¡®ä¿ç»“æŸä¸Šä¸€ä¸ªç¬”ç”»/äº‹ä»¶
            if (currentStroke) {
                const now = Date.now();
                if (currentStroke.type === 'stroke') {
                    currentStroke.duration = now - currentStroke.startTime;
                    recordedStrokes.push(currentStroke);
                } else if (currentStroke.type === 'drum') {
                    currentStroke.duration = 50; 
                    recordedStrokes.push(currentStroke);
                }
            }
            currentStroke = null;
            
            recordBtn.classList.remove('disabled');
            stopBtn.classList.add('disabled');
            playBtn.classList.remove('disabled');
            console.log(`â¹ åœæ­¢å½•åˆ¶ã€‚è®°å½•äº† ${recordedStrokes.length} ä¸ªäº‹ä»¶ã€‚`);
            
            // è‡ªåŠ¨æ’­æ”¾é¢„è§ˆ
            handlePlay(); 
        }

        /** æ’­æ”¾å½•åˆ¶çš„ç¬”ç”»å’Œå£°éŸ³ */
        function handlePlay() {
            if (recordedStrokes.length === 0) {
                console.log("æ²¡æœ‰å½•åˆ¶æ•°æ®å¯æ’­æ”¾ã€‚");
                return;
            }
            
            console.log("â–¶ï¸ æ’­æ”¾ä¸­...");
            playBtn.classList.add('disabled');
            recordBtn.classList.add('disabled');
            
            // æ¸…ç©ºç”»å¸ƒä½†ä¸æ¸…ç©ºè®°å½•
            ctx.clearRect(0, 0, canvas.width, canvas.height); 

            let maxDuration = 0;
            
            recordedStrokes.forEach(stroke => {
                const { startTime, duration, h, s, l, size, type } = stroke;
                const endTime = startTime + duration;
                maxDuration = Math.max(maxDuration, endTime);
                
                const delaySeconds = (startTime - recordingStartTime) / 1000;
                
                if (type === 'drum') {
                    // é¼“ç‚¹ï¼šä»…åœ¨å¼€å§‹æ—¶æ’­æ”¾ä¸€æ¬¡
                    setTimeout(() => {
                        playDrum();
                        // ç»˜åˆ¶ä¸€ä¸ªç‚¹æ¥è¡¨ç¤ºé¼“ç‚¹äº‹ä»¶
                        ctx.fillStyle = getCssColor(h, s, l);
                        ctx.beginPath();
                        ctx.arc(stroke.points[0].x, stroke.points[0].y, size / 2, 0, Math.PI * 2);
                        ctx.fill();
                    }, startTime - recordingStartTime);
                } else if (type === 'stroke') {
                    // æŒç»­éŸ³ï¼šå¼€å§‹å’Œåœæ­¢å£°éŸ³
                    
                    // 1. å£°éŸ³å¼€å§‹
                    setTimeout(() => {
                        startSound(h, s, l);
                    }, startTime - recordingStartTime);

                    // 2. å£°éŸ³å’Œç»˜ç”»åœæ­¢ (å»¶è¿Ÿæ—¶é—´æ˜¯æ€»æ—¶é•¿)
                    setTimeout(() => {
                        stopSound();
                    }, endTime - recordingStartTime);
                    
                    // 3. ç®€åŒ–ç»˜ç”»ï¼šè¿™é‡Œæˆ‘ä»¬åªç”»ä¸€æ¡çº¿ä»£è¡¨ç¬”ç”»ï¼ŒçœŸæ­£çš„è½¨è¿¹éœ€è¦è®°å½•æ‰€æœ‰ points
                    // å¤æ‚çš„è½¨è¿¹æ’­æ”¾éœ€è¦æ›´å¤šæ•°æ®å’Œå¾ªç¯ï¼Œæ­¤å¤„ä¸ºç®€åŒ–ç¤ºä¾‹
                    setTimeout(() => {
                         const startP = stroke.points[0];
                         const endP = stroke.points[stroke.points.length - 1]; // å®é™…åº”ç”¨ä¸­éœ€è¦è®°å½•å¹¶å›æ”¾æ‰€æœ‰ç‚¹
                         
                         ctx.beginPath();
                         ctx.moveTo(startP.x, startP.y);
                         ctx.lineTo(endP.x + 1, endP.y + 1); // ç¡®ä¿å³ä½¿æ˜¯çŸ­ç‚¹ä¹Ÿä¼šè¢«ç»˜åˆ¶
                         ctx.strokeStyle = getCssColor(h, s, l);
                         ctx.lineWidth = size;
                         ctx.lineCap = 'round';
                         ctx.stroke();
                    }, startTime - recordingStartTime);
                }
            });
            
            // æ’­æ”¾å®Œæˆåé‡æ–°å¯ç”¨æŒ‰é’®
            setTimeout(() => {
                playBtn.classList.remove('disabled');
                recordBtn.classList.remove('disabled');
                console.log("æ’­æ”¾ç»“æŸã€‚");
            }, maxDuration - recordingStartTime + 200); // é¢å¤–200msç¡®ä¿å£°éŸ³åœæ­¢
        }
        
        function handleClear() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            recordedStrokes = [];
            currentStroke = null;
            isRecording = false;
            
            recordBtn.classList.remove('disabled');
            stopBtn.classList.add('disabled');
            playBtn.classList.add('disabled');
            console.log("ç”»å¸ƒå’Œå½•éŸ³å·²æ¸…ç©ºã€‚");
        }

        recordBtn.addEventListener('click', handleRecord);
        stopBtn.addEventListener('click', handleStop);
        playBtn.addEventListener('click', handlePlay);
        clearBtn.addEventListener('click', handleClear);

    </script>
</body>
</html>
